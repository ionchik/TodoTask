{% extends 'tasks/base.html' %}

{% block content %}
{% if user.is_authenticated %}
<div class="container my-5">
    <h1 class="text-center fw-bold" style="color: #2c3e50;">Ваши задачи</h1>
    <div class="row mt-4 g-4">
        {% for task in tasks %}
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="card shadow-sm task-card h-100" style="border-radius: 15px; transition: transform 0.3s;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-truncate" style="color: {% if task.completed %}#28a745{% else %}#343a40{% endif %};">
                        {{ task.title }}
                    </h5>
                    <p class="card-text text-secondary mb-3" style="font-size: 0.9rem;">{{ task.description|truncatechars:60 }}</p>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                        <label class="d-flex align-items-center" title="Изменить статус задачи">
                            <input type="checkbox" class="task-status-toggle visually-hidden" id="task-{{ task.id }}" data-task-id="{{ task.id }}" {% if task.completed %}checked{% endif %}>
                            <span class="checkmark"></span>
                        </label>
                        <div class="btn-group gap-2">
                            <a href="{% url 'tasks:task' task.pk %}" class="btn btn-sm btn-outline-secondary" title="Подробнее">
                                <i class="bi bi-info-circle"></i> Подробнее
                            </a>
                            <a href="{% url 'tasks:delete_task' task.id %}" class="btn btn-sm btn-outline-danger" title="Удалить задачу">
                                <i class="bi bi-trash"></i> Удалить
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center" role="alert">
                У вас пока нет задач.
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- FAB кнопка для создания новой задачи -->
    <div class="fab-container">
        <a href="{% url 'tasks:create_task' %}" class="fab" title="Создать задачу">
            <i class="bi bi-plus-circle"></i>
        </a>
    </div>
</div>

<script>
    document.querySelectorAll('.task-status-toggle').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const isChecked = this.checked;

            fetch(`/${taskId}/change_status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: isChecked })
            }).then(response => {
                if (response.ok) {
                    response.json().then(data => {
                        const title = checkbox.closest('.card-body').querySelector('.card-title');
                        title.style.color = data.completed ? '#28a745' : '#343a40';
                    });
                }
            });
        });
    });
</script>

<style>
    .task-card:hover {
        transform: translateY(-5px);
    }

    .checkmark {
        display: block;
        width: 20px;
        height: 20px;
        border: 2px solid #6c757d;
        border-radius: 50%;
        background-color: #fff;
        position: relative;
        transition: all 0.3s ease;
    }

    .task-status-toggle:checked + .checkmark {
        background-color: #28a745;
        border-color: #28a745;
    }

    .task-status-toggle:checked + .checkmark:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 10px;
        height: 10px;
        background-color: #fff;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1030;
    }

    .fab {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #007bff;
        color: #fff;
        font-size: 24px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .fab:hover {
        background-color: #0056b3;
        transform: scale(1.1);
    }

    @media (max-width: 768px) {
        .task-card {
            box-shadow: none;
        }

        .task-card:hover {
            transform: none;
        }
    }
</style>
{% endif %}
{% endblock %}
